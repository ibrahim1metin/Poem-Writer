import os
os.environ.setdefault("TF_ENABLE_ONEDNN_OPTS","0")
os.environ["TF_ENABLE_ONEDNN_OPTS"]="0"
import warnings
warnings.filterwarnings("ignore")
from transformers import GPT2TokenizerFast,AutoTokenizer,GPT2LMHeadModel,GenerationConfig
from transformers import StoppingCriteriaList
from tokenizers.processors import TemplateProcessing
from utils import StopByTokenCriteria, get_bad_words_ids
from tokenizers import Tokenizer
import torch

DEVICE="cuda" if torch.cuda.is_available() else "cpu"
model_string="erythropygia/gpt2-turkish-base"
pretrained="./saved/models/gpt2/checkpoint-5460"
eos = '<|endoftext|>'
pad = '<|pad|>'
special_tokens_dict = {'eos_token': eos,
                       'pad_token' : pad,
                      }
tokenizer_orig = AutoTokenizer.from_pretrained(model_string,add_prefix_space=True)
tokenizer_orig.add_special_tokens(special_tokens_dict)
tokenizer = Tokenizer.from_pretrained(model_string)
tokenizer.post_processor = TemplateProcessing(
    single="$A " + eos,
    special_tokens=[(eos, tokenizer_orig.eos_token_id),
                    (pad, tokenizer_orig.pad_token_id),
    ],
)
tokenizer_gpt = GPT2TokenizerFast(tokenizer_object=tokenizer,
                                  padding_side='left',
                                  add_prefix_space=True,
                                  )
num_added_toks=tokenizer_gpt.add_special_tokens(special_tokens_dict)
MAX_LENGTH=16
PUNCTUATION_IDS=[[1], [2], [3], [4], [5], [6], [7], [8], [9], [10], [11], [12], [13], [14], [15], [26], [27], [28], [29], [30], [31], [32], [59], [60], [61], [62], [63], [64], [91], [92], [93], [94], [3249], [7114]]
SINGLE_LETTERS=[[65], [66], [67], [270], [68], [69], [70], [71], [269], [72], [129], [73], [74], [75], [76], [77], [78], [79], [281], [80], [82], [83], [262], [84], [85], [259], [86], [89], [90], [33], [34], [35], [875], [36], [37], [38], [39], [1354], [40], [41], [41], [42], [43], [44], [45], [46], [47], [911], [48], [50], [51], [499], [52], [53], [715], [54], [57], [58], [221],[853], [263], [446], [319], [272], [1674], [353], [278], [14180], [297], [7644], [287], [2529], [271], [657], [308], [367], [282], [342], [341], [422], [273], [368], [286], [1150], [12610], [283], [275], [416], [323], [312], [485], [542], [371], [388], [477], [399], [221], [384], [809], [809], [1146], [335], [641], [352], [529], [461], [590], [430], [549], [340], [625], [347], [677], [748], [588], [401], [912],[199],[87],[55],[1264],[1113],[88],[56],[4766],[2831],[81],[49],[21770],[4633],[4756], [7114], [12241], [25698], [31232], [31715], [33907], [37896], [42713], [355], [493], [827], [1091], [2855], [4479], [4667], [5268], [5654], [7153], [9344], [9414], [10263], [10903], [11206], [12026], [12639], [17616], [17689], [18209], [20836], [21317], [24939], [24955], [25552], [26966], [27727], [30737], [31841], [34062], [40458], [40472], [41093], [41305], [42274], [42877], [43170], [43686], [46528], [46794], [49140], [50197], [1388], [25031], [36320], [41580], [46212], [5237], [47306], [1555], [12768], [3337], [857], [2873], [3954], [4373], [9745], [11863], [12342], [14897], [17895], [20930], [29680], [31720], [38939], [38952], [40113], [45013], [45603], [46745], [484], [9819], [18174], [24855], [35638], [39400], [43071], [43743], [45289], [47453], [3108], [3952], [4188], [6479], [9594], [12809], [13133], [18005], [18108], [22735], [24547], [25338], [28306], [29925], [30010], [30280], [30844], [32912], [36304], [37909], [44068], [2480], [4045], [8111], [9963], [14327], [32883], [33194], [35377], [37420], [3621], [31690], [38070], [1481], [1552], [3308], [3558], [8713], [8895], [18187], [20488], [21462], [24274], [33349], [35132], [40408], [46122], [48641], [603], [3335], [6940], [13183], [14983], [16473], [17250], [19253], [26822], [30661], [36646], [38865], [39766], [47092], [418], [706], [1175], [1778], [2051], [2100], [3249], [3796], [7220], [7294], [8666], [8976], [14041], [14423], [16862], [17468], [17751], [19132], [20392], [22995], [23973], [24782], [25395], [26619], [28956], [30819], [31072], [31231], [32174], [33755], [36209], [37538], [37802], [39855], [40060], [41948], [42285], [42356], [45566], [47723], [47996], [48492], [1385], [2821], [2914], [18454], [25310], [32779], [42494],[4730],[3272],[7918],[28742],[6690], [17472], [21697], [24220], [43222], [6611], [7655], [29900], [32885], [47906], [9947], [49838], [4730], [16927], [32470], [0], [3285], [21475], [24566], [28559], [39524], [41830], [47583], [3272], [7918], [28742], [31472], [38132], [47358], [8385],[2299]]
NUMBERS=[[486], [582], [666], [972], [1016], [1377], [1404], [1739], [1815], [1915], [1922], [1927], [2263], [2492], [2613], [3560], [3598], [3748], [3831], [3886], [4254], [4348], [4383], [4412], [4632], [4695], [5253], [5473], [5486], [5541], [5909], [6824], [7017], [7395], [7570], [7740], [7764], [8592], [8841], [9219], [11313], [11581], [11750], [12463], [12556], [12680], [13165], [14084], [14123], [14796], [15206], [15937], [16197], [16353], [16632], [16913], [17139], [17212], [17215], [17659], [17823], [18485], [19091], [19187], [19640], [19698], [19778], [19834], [20167], [20264], [20767], [21046], [21203], [21690], [22038], [22962], [23110], [24071], [24632], [24913], [25427], [26128], [26571], [26899], [26989], [27848], [27849], [28159], [28547], [29016], [29221], [29861], [30387], [30688], [30940], [31202], [31564], [32034], [32211], [32463], [32511], [32927], [33846], [33910], [34995], [35098], [35328], [35333], [35468], [35871], [35873], [36368], [37159], [37621], [38658], [38980], [39329], [39534], [39638], [39947], [40608], [41429], [42181], [42326], [42912], [43177], [43409], [43991], [44093], [44467], [44841], [44896], [45428], [45582], [45615], [46431], [47182], [47524], [47775], [48651], [48836], [49039], [49135], [49304], [49678], [50008], [385], [648], [1160], [1198], [1564], [1889], [2004], [2393], [3183], [3739], [4120], [4493], [4499], [5507], [6140], [6627], [8107], [10336], [10531], [10542], [11312], [11528], [12396], [13414], [14984], [15223], [16341], [17347], [18039], [19317], [20342], [20372], [23422], [26728], [27472], [27623], [29652], [31403], [32642], [32809], [33813], [36354], [39927], [41009], [42075], [42261], [42416], [42686], [44595], [45760], [45778], [46111], [46530], [48537], [49013], [386], [1443], [1620], [1764], [2435], [3168], [3482], [3608], [4911], [5981], [6081], [6615], [6719], [6851], [7405], [9862], [10079], [10473], [11639], [11659], [12977], [13502], [13973], [14469], [15375], [16462], [16717], [17381], [18712], [19074], [22402], [24119], [27450], [29004], [31108], [31679], [32687], [33219], [35279], [35366], [35614], [36274], [36808], [37087], [37213], [38555], [40938], [41271], [41523], [41671], [41696], [43081], [45231], [46545], [46739], [47187], [47533], [47941], [48167], [48940], [49034], [50071], [609], [1700], [2432], [2596], [2681], [3125], [3176], [4401], [6058], [6141], [6965], [7212], [8033], [10203], [10834], [11086], [11463], [11736], [12560], [13793], [14051], [14580], [16718], [17001], [17419], [17945], [18924], [24614], [24662], [24704], [25464], [26960], [30214], [31384], [31389], [32391], [33304], [34264], [38303], [38930], [38994], [41915], [42333], [42507], [43319], [43559], [44704], [44937], [46375], [46509], [47140], [47217], [49824], [750], [1677], [2209], [2498], [2516], [3048], [3281], [4477], [4737], [5871], [6528], [7676], [8024], [9330], [9755], [10147], [11018], [11044], [11919], [13765], [14410], [15847], [16031], [16488], [17524], [18872], [22486], [23541], [23681], [25727], [29724], [31059], [32529], [32920], [33627], [34613], [34803], [34904], [36735], [37428], [38715], [38938], [39838], [42195], [42263], [42431], [44290], [45363], [45798], [45840], [46451], [46737], [46977], [47769], [48781], [49478], [49551], [743], [1292], [2101], [2319], [2559], [2793], [2999], [3911], [3986], [4573], [4889], [5415], [5462], [5604], [5970], [6510], [8305], [8386], [8440], [8918], [9028], [10611], [12108], [13382], [14615], [15718], [18118], [22101], [22980], [23312], [24517], [24617], [26747], [26959], [28466], [28689], [29408], [29796], [30391], [31364], [31979], [32563], [32807], [33256], [33414], [33885], [36975], [38214], [38399], [38992], [39562], [39717], [40428], [40923], [44019], [44368], [44523], [44792], [45395], [45453], [45653], [46137], [46664], [46719], [47884], [47930], [49357], [49381], [49568], [49836], [950], [1729], [2395], [2556], [3290], [3310], [3311], [4540], [4988], [5381], [5898], [6229], [6948], [7044], [7782], [8045], [9943], [10120], [12078], [12249], [12851], [13391], [14626], [15728], [15955], [17137], [17605], [22749], [23049], [27802], [28783], [29156], [30335], [32467], [33537], [33979], [35453], [35711], [38206], [38216], [38276], [38781], [39786], [40035], [40840], [41557], [41929], [41933], [43369], [44267], [44622], [45472], [46351], [46704], [46727], [48889], [49500], [49601], [50112], [1023], [1822], [2179], [2656], [3247], [3352], [3366], [4668], [4866], [5201], [5266], [6260], [6539], [6573], [7737], [7961], [8793], [9130], [11077], [12743], [13320], [13545], [14291], [15196], [15457], [18399], [18752], [21998], [27620], [27867], [28504], [28528], [32103], [32718], [33513], [37589], [38979], [38996], [39866], [40584], [40862], [41286], [41321], [41661], [42363], [43154], [43400], [45526], [45768], [46092], [46287], [49097], [1121], [1583], [2108], [2316], [3178], [3275], [3344], [4298], [4747], [4852], [5016], [5038], [5332], [5827], [5990], [7041], [7184], [8039], [8095], [9189], [9415], [9707], [10141], [12719], [14745], [15858], [16436], [16737], [19887], [22290], [24827], [26549], [26643], [27171], [29185], [31107], [32325], [35260], [35487], [35912], [37700], [38322], [38352], [38387], [38471], [39092], [41777], [41883], [41971], [42906], [43048], [43502], [44905], [46342], [47647], [47649], [49211], [49989], [942], [1248], [1318], [2068], [2933], [3253], [3520], [3551], [4054], [4214], [4840], [5041], [5073], [5328], [5895], [6500], [7971], [8541], [9214], [9654], [9794], [11265], [12064], [12228], [12506], [16605], [17323], [18762], [19788], [22985], [24377], [25680], [28800], [29970], [30642], [35570], [35656], [36981], [40238], [40321], [40490], [40529], [41682], [42556], [42651], [42961], [42995], [44864], [46825], [46891], [47415], [49045], [1179]]
TRAIN_RATIO=.8
STOPPING_CRITERIA=StoppingCriteriaList([
    StopByTokenCriteria(eos_token_id=tokenizer_gpt.eos_token_id),
])
model_lm=GPT2LMHeadModel.from_pretrained(pretrained).to(DEVICE)
model_lm.resize_token_embeddings(len(tokenizer_gpt))

GENERATION_CONFIG=GenerationConfig(
    no_repeat_ngram_size=3,
    repetition_penalty=2.,
    max_new_tokens=MAX_LENGTH,
    pad_token_id=tokenizer_gpt.pad_token_id,
    eos_token_id=tokenizer_gpt.eos_token_id,
    top_k=85,
    top_p=0.95,
    temperature=1.2,
    num_beams=4,
    do_sample=True,
    bad_words_ids=[[2299],[199],[42061],*PUNCTUATION_IDS,*SINGLE_LETTERS],
    min_new_tokens=5,
)